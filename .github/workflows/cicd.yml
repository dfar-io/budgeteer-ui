# https://github.com/google-github-actions/upload-cloud-storage
# https://github.com/google-github-actions/auth?tab=readme-ov-file#preferred-direct-workload-identity-federation
name: CICD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  cicd:
    # required for google-github-actions/auth
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    # - if: github.event_name == 'pull_request'
    #   run: docker build .
    - uses: 'google-github-actions/auth@v2'
      #if: github.ref == 'refs/heads/main'
      with:
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.SERVICE_ACCOUNT }}
    # https://github.com/google-github-actions/deploy-cloudrun
    - uses: google-github-actions/deploy-cloudrun@v2
      #if: github.ref == 'refs/heads/main'
      with:
        service: ui
        # https://cloud.google.com/run/docs/deploying-source-code
        source: .
        project_id: ${{ secrets.PROJECT_ID }}
